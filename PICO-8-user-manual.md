# PICO-8 用户手册

> [!IMPORTANT]
>
> 该版本的手册属于非官方翻译，由 fadedflower 个人翻译并自用，出现翻译错误属于正常现象，请务必指出

PICO-8 v0.2.6  
https://www.pico-8.com  
(c) Copyright 2014-2024 Lexaloffle Games LLP  
作者：Joseph White // hey@lexaloffle.com 

PICO-8 的构建用到下面这些库： 

SDL2 http://www.libsdl.org  
Lua 5.2 http://www.lua.org  // 见 license.txt  
ws281x by jgarff       // 见 license.txt  
GIFLIB http://giflib.sourceforge.net/  
WiringPi http://wiringpi.com/  
libb64 by Chris Venter  
miniz by Rich Geldreich  
z8lua by Sam Hocevar https://github.com/samhocevar/z8lua

本手册的最新版本（格式含 html，txt）以及其他资源：

https://www.lexaloffle.com/pico-8.php?page=resources

## 欢迎来到 PICO-8

PICO-8 是一款虚构游戏机，能够制作、分享和游玩小游戏以及其他计算机程序。启动时，机器首先会给你提供一个 Shell，用来输入 Lua 程序。它还提供了简单的内置工具，用来创建精灵图像、地图和声音。

PICO-8 的严苛限制是经过精挑细选的，这样使用起来会更有乐趣，鼓励小而精的设计，希望能给予 PICO-8 卡带独特的外表和风格。

## 技术规范

> 显示屏：   128x128，固定 16 色色板  
> 输入：       6 按钮控制器  
> 卡带：       32k 数据，以 png 文件格式存储  
> 声音：       4 通道，64 清晰度芯片  
> 代码：       P8 Lua（代码最高 8192 个 Token）  
> CPU：       每秒 4M 虚拟机指令  
> 精灵图像：单块 128 个 8x8 精灵图像（附加 128 个图像，位于共享内存）  
> 地图：       128x32 瓦片地图（附加 128x32 地图，位于共享内存）

# 1 起步

## 1.1 键位

> ALT+ENTER：切换全屏  
> ALT+F4：       快速退出（Windows）  
> CTRL-Q：      快速退出（Mac，Linux）  
> CTRL-R：      重载 / 运行 / 重启卡带  
> CTRL-S：      快速保存当前卡带  
> CTRL-M：     静音 / 取消静音  
> ENTER / P：  暂停菜单（卡带运行期间）

> 玩家 1 默认键位：鼠标指针 + ZX / NM / CV  
> 玩家 2 默认键位：SDFE + tab，Q / shift A

要改变默认键位，在 PICO-8 内部使用 KEYCONFIG 实用工具：

```
> KEYCONFIG
```

## 1.2 Hello World

PICO-8 启动后，尝试输入下面这些命令并用 enter 键结束：

``````lua
> PRINT("HELLO WORLD")
> RECTFILL(80,80,120,100,12)
> CIRCFILL(70,90,20,14)
> FOR I=1,4 DO PRINT(I) END
``````

> [!NOTE]
>
> PICO-8 只显示大写字符 -- 所以只需要正常输入，不需要大写锁定！

在代码编辑模式中，使用像这样的命令以及两个特殊的回调函数 `_UPDATE` 和 `_DRAW` ，你可以构建一个交互式程序。例如，接下来这个程序允许你使用方向键四处移动一个圆。按 Esc 键切换到代码编辑器，输入或者复制粘贴下列代码：

``````lua
X = 64  Y = 64
FUNCTION _UPDATE()
  IF (BTN(0)) THEN X=X-1 END
  IF (BTN(1)) THEN X=X+1 END
  IF (BTN(2)) THEN Y=Y-1 END
  IF (BTN(3)) THEN Y=Y+1 END
END
 
FUNCTION _DRAW()
  CLS(5)
  CIRCFILL(X,Y,7,14)
END
``````

现在按下 Esc 键回到终端，输入 `RUN` （或者按下 CTRL-R）查看运行结果。需要更复杂的程序，请参考 Demo 卡带（输入 `INSTALL_DEMOS`）。

如果你想要保存你的程序，日后再用，使用 `SAVE` 命令：

``````
> SAVE PINKCIRC
``````

要再次加载这个程序：

``````
> LOAD PINKCIRC
``````

## 1.3 示例卡带

这些卡带包含在 PICO-8 里，若要安装，输入下面的命令：

``````
> INSTALL_DEMOS
> CD DEMOS
> LS
 
HELLO      来自 PICO-8 的问候
API        演示大部分 PICO-8 的功能
JELPI      平台游戏 Demo 以及 2p 支持
CAST       2.5D 光线投射 Demo
DRIPPY     绘制往下流淌的涂鸦
WANDER     简单的步行模拟器
COLLIDE    墙和物体碰撞的示例
``````

要运行一个卡带，打开 PICO-8 并输入：

``````
> LOAD JELPI
> RUN
``````

按 Esc 键停止程序运行，再按一次进入编辑模式。

一小部分 BBS 卡带可以用下面的命令安装到 `/GAMES` ：

``````
> INSTALL_GAMES
``````

## 1.4 文件系统

以下这些命令用来管理文件和目录（文件夹）：

``````
LS          列出当前目录
CD BLAH     切换目录
CD ..       切换上一级目录
CD /        切换回根目录（在 PICO-8 的虚拟磁盘）
MKDIR BLAH  创建一个目录
FOLDER      在宿主操作系统的文件浏览器中打开当前目录
``````

`LOAD BLAH` 从当前目录中加载一个卡带，`SAVE BLAH` 将卡带保存到当前目录。

如果你想要把文件移到别处，复制一份或者删除他们，使用 `FOLDER` 命令并在宿主操作系统中完成这些操作。

PICO-8 的磁盘的默认位置是：

Windows：C:/Users/Yourname/AppData/Roaming/pico-8/carts  
OSX：/Users/Yourname/Library/Application Support/pico-8/carts  
Linux：~/.lexaloffle/pico-8/carts

你可以在 `pico-8/config.txt` 中修改这个位置以及其他设置。

> [!TIP]
>
> 磁盘目录可以映射到云盘（Dropbox，Google Drive 或者类似的平台），这能够在不同宿主机上的 PICO-8 机器中共享单一磁盘。

## 1.5 加载和保存

使用 `LOAD` 和 `SAVE` 的时候，`.P8` 扩展名可以省略，它会自动添加。

``````
> SAVE FOO
SAVED FOO.P8
``````

卡带文件也可以拖放到 PICO-8 窗口以加载。

使用 `.p8.png` 文件扩展名可以以一种特殊的图像格式保存卡带，看上去像一个卡带。使用 `.p8.rom` 会保存为原始的 32k 二进制格式。

使用 `@clip` 文件名以加载或保存到剪贴板。

如果卡带能在 2040 个字符内进行编码（只含代码和 gfx），使用 `@url` 文件名以生成 pico-8-edu.com 链接并保存到剪贴板。

一旦加载或保存了卡带，你还能用 CTRL-S 快速保存卡带。

### 保存为 .p8.png 卡带，带有文本标签和预览图像

要生成一个附在卡带上的标签图像，首先运行程序并按下 CTRL-7 捕捉屏幕当前的图像。以“--”开头的前两行程序文本也会被绘制到卡带的标签上。

``````
-- OCEAN DIVER LEGENDS
-- BY LOOPY
``````

### .p8.png / .p8.rom 格式的代码大小限制

保存为 `.png` 或 `.rom` 格式时，代码的压缩大小必须少于 15360 字节，这样总大小就会小于等于 ß32k。

要了解代码当前的大小，使用 `INFO` 命令。保存为 `.p8` 格式则没有这种压缩大小的限制。

## 1.6 使用外部文本编辑器

用单独的文本编辑器直接编辑 `.p8` 文件是可行的。满足下列条件时，使用 CTRL-R 运行卡带会自动重载文件：

1. PICO-8 编辑器中没有未保存的改动
2. 文件内容与上一次加载的版本相比有改动

如果磁盘上的卡带和编辑器内都有所改动，屏幕会显示一条通知：

``````
DIDN'T RELOAD; UNSAVED CHANGES
``````

还有另一种方法，`.lua` 文本文件可以在单独的文本编辑器中修改，之后在卡带中使用 `#INCLUDE` （在合适的代码位置），这样每次运行时，这些代码都会包含到卡带代码中：

``````lua
#INCLUDE YOURFILE.LUA
``````

## 1.7 备份

当你不保存改动并退出，或者覆盖已有文件时，卡带的一份备份会保存到 `{appdata}/pico-8/backup` 。输入 `BACKUP` 也会把当前卡带的副本保存到相同的文件夹。

要在宿主操作系统的文件浏览器中打开备份文件夹，使用：

``````
> FOLDER BACKUPS
``````

把这些文件拖放到 PICO-8 窗口以进行加载是可行的。

从版本 0.2.4c 开始，如果编辑器不处于空闲状态，每 20 分钟会保存一份周期备份，这也就意味着备份文件夹的大小每 5 小时会增长大概 1MB。这项设置可以在 `config.txt` 中禁用或调整

## 1.8 配置

每次会话的开始，PICO-8 会从 `config.txt` 中读取配置信息，退出时也会保存配置（所以你应当在 PICO-8 未运行的时候编辑 `config.txt` 文件）

`config.txt` 文件的位置取决于宿主操作系统：

Windows：C:/Users/Yourname/AppData/Roaming/pico-8/config.txt  
OSX：/Users/Yourname/Library/Application Support/pico-8/config.txt  
Linux：~/.lexaloffle/pico-8/config.txt

使用 `-home` 开关（下文所述）可以用不同的路径来存放 `config.txt` 以及其他数据。

有些设置可以在 PICO-8 运行期间进行修改，输入 `CONFIG SETTING VALUE` 。（输入 `CONFIG` 本身来获取设置列表）

### 命令行参数

> [!NOTE]
>
> 这些开关会覆盖 `config.txt` 里的设置

pico8 [switches] [filename.p8]

| 开关                 | 含义                                                         |
| -------------------- | ------------------------------------------------------------ |
| -width n             | 设置窗口宽度                                                 |
| -height n            | 设置窗口高度                                                 |
| -windowed n          | 设置窗口模式为关（0）或开（1）                               |
| -volume n            | 设置音频音量 0..256                                          |
| -joystick n          | 从玩家 n (0..7) 开始使用摇杆控制                             |
| -pixel_perfect n     | 1 为无过滤的整数倍屏幕缩放（默认是开）                       |
| -preblit_scale n     | 复制到屏幕前，显示缩放 n 倍（和 -pixel_perfect 0 一起时比较有用） |
| -draw_rect x,y,w,h   | 绘制 PICO-8 屏幕的绝对窗口坐标和大小                         |
| -run filename        | 加载并运行卡带                                               |
| -x filename          | 以无头模式执行 PICO-8 卡带，随后退出（实验性功能！！）       |
| -export param_str    | 以无头模式运行 EXPORT 命令，随后退出（参阅导出部分下的注解） |
| -p param_str         | 把一个参数字符串传递到指定卡带                               |
| -splore              | 以 splore 模式启动                                           |
| -home path           | 设置存放 config.txt 和其他用户数据文件的路径                 |
| -root_path path      | 设置存放卡带文件的路径                                       |
| -desktop path        | 设置保存截图和 gif 的位置                                    |
| -screenshot_scale n  | 截图的缩放。默认值：3（368x368 像素）                        |
| -gif_scale n         | gif 捕捉的缩放。默认值：2（256x256 像素）                    |
| -gif_len n           | 以秒为单位，设置 gif 的最大长度（1..120）                    |
| -gui_theme n         | 使用 1 设置高对比度编辑器配色方案                            |
| -timeout n           | 下载超时前要等待多少秒（默认值：30）                         |
| -software_blit n     | 设置使用软件 Blit 模式为关（0）或开（1）                     |
| -foreground_sleep_ms | 帧与帧之间要休眠多少毫秒                                     |
| -background_sleep_ms | 后台运行时，帧与帧之间要休眠多少毫秒                         |
| -accept_future n     | 1 为允许加载使用未来版本的 PICO-8 制作的卡带                 |
| -global_api n        | 1 为 API 函数留在全局作用域（调试时有用）                    |



### 控制器设置

PICO-8 使用 SDL2 控制器配置方案，启动时会探测常见控制器，同时也会在与 config.txt 同目录的 `sdl_controllers.txt` 中寻找自定义映射。  
`sdl_controller.txt` 每行有一条映射。

要为你的控制器生成自定义映射字符串，要么使用 SDL2 附带的 `controllermap` 程序，要么尝试 http://www.generalarcade.com/gamepadtool/

要得知 SDL2 探测得到的控制器 ID，运行 PICO-8 之后，在 log.txt 中查找 `joysticks` 或者 `Mapping` 。不同的操作系统，ID 有可能有所区别。参见：https://www.lexaloffle.com/bbs/?tid=32130

要设置哪些键盘按键触发摇杆按键，使用 `KEYCONFIG` 。

## 1.9 截图和 GIF

卡带运行的时候，使用：

> CTRL-6 保存截图到桌面  
> CTRL-7 捕捉卡带标签图像  
> CTRL-8 开始录制视频  
> CTRL-9 保存 GIF 视频到桌面（默认 8 秒）

你可以随时保存视频（视频永远都在录制）；CTRL-8 只是重置视频的起始点。录制时间要长于 8 秒，使用 `CONFIG` 命令（最大值：120）

``````
CONFIG GIF_LEN 60
``````

如果你想要录制每次都重置（以创建不重叠的序列），使用：

``````
CONFIG GIF_RESET_MODE 1
``````

gif 格式无法精确到 30fps ，所以 PICO-8 转而使用最接近的值：33.3fps。

如果你保存到桌面时出现了问题，请尝试在 `config.txt` 中配置别的桌面路径

## 1.10 分享卡带

有三种方式能分享用 PICO-8 制作的卡带：

1. 直接与其他 PICO-8 用户分享 `.p8` 或 `.p8.png` 文件

   输入 `FOLDER` 以在你的宿主操作系统中打开当前文件夹

2. 把卡带发送到 Lexaloffe BBS 以获得可在网页游玩的版本

   http://www.lexaloffle.com/pico-8.php?page=submit

3. 导出卡带到独立的 html/js 或者原生二进制播放器（参阅“导出工具”小节以得到更多细节）

## 1.11 SPLORE

`SPLORE` 是一个内置实用工具，用来浏览并组织本地和 bbs（在线）卡带。输入 `SPLORE` [enter] 启动，或者用`-splore` 开关启动 PICO-8 。

完全用摇杆控制 `SPLORE` 是可行的：

> LEFT 和 RIGHT 切换卡带列表  
> UP 和 DOWN 选择每个列表的项目  
> X，O 或 MENU 启动卡带

在卡带内，按 MENU 收藏一个卡带或退回 `SPLORE` 。如果你使用键盘，在卡带列表视图中选中卡带后，可以按 F 收藏卡带。

查看 BBS 卡带列表时，使用最顶部的一项重新下载卡带列表。如果你处于离线状态，显示的就是最后一次下载的列表，你依然可以游玩你已经下载的卡带。

如果你在没有互联网访问的机器上安装了 PICO-8 ，你也可以使用 `INSTALL_GAMES` 添加一小部分预装的 BBS 卡带到 `/games`

# 2 编辑工具

按 ESC 切换终端和编辑器。  
编辑模式下，点击右上角的选项卡可以切换，也可以按 ALT+LEFT/RIGHT 切换。

## 2.1 代码编辑器

> 按住 Shift 以选择（或者点击并拖动鼠标）  
> CTRL-X，C，V 分别是剪切，复制和粘贴选中代码  
> CTRL-Z，Y 分别是撤销，重做  
> CTRL-F 在当前选项卡中查找文本  
> CTRL-G 重复上一次搜索  
> CTRL-L 跳转到行号  
> CTRL-UP，DOWN 分别是跳转到起始和末尾  
> ALT-UP，DOWN 分别是浏览上一个和下一个函数  
> CTRL-LEFT，RIGHT 按单词跳转  
> CTRL-W，E 分别是跳转到当前行的行首和行尾  
> CTRL-D 重复当前行  
> TAB 向右缩进选择项（按住 Shift 向左缩进）  
> CTRL-B 注释 / 取消注释选中块  
> CTRL-U 获取光标下的关键字的帮助信息

要输入代表按钮的特殊字符（以及其他字形），使用 SHIFT-L，R，U，D，O，X 。还有 3 种额外的字体输入模式可以切换：

> CTRL-J 平假名  // 输入等价的罗马音 (ka, ki, ku..)  
> CTRL-K 片假名  // + shift-0..9 获取额外符号  
> CTRL-P 小字体  // 按住 shift 输入标准字体

> [!NOTE]
>
> 默认情况下，小字体字符在复制 / 粘贴时是以 Unicode 斜体字符编码的，大小写 ASCII 字符都粘贴为正常的 PICO-8 字符。要以大写 ASCII 形式复制 / 粘贴小字体字符，请确保小字体模式（CTRL-P）处于启用状态。

### 代码选项卡

点击顶部的 [+] 按钮添加新选项卡。左键点击或使用 CTRL-TAB，SHIFT-CTRL-TAB 切换选项卡。要移除最后一个选项卡，删除所有内容并切换到别的选项卡（CTRL-A，DEL，CTRL-TAB）

运行卡带的时候，所有的选项卡会按顺序拼接，生成一个单一程序。

### 代码限制

代码的 Token 数显示在右下角。一个程序最大可以有 8192 个 Token。每一个 Token 是一个单词（例如变量名）或者运算符。每个括号对和字符串算作 1 个 Token。逗号，句号，`LOCAL` ，分号，`END` 和注释不算。

右键点击可以切换其他统计信息（字符数，压缩大小）。如果达到了某个限制，编辑器会闪烁警告灯。这可以用右键来禁用。

## 2.2 精灵编辑器

精灵编辑器既可以用于精灵方面的编辑，也可以用于任意的像素图像编辑。屏幕底部的精灵浏览器提供了对精灵表（Sprite sheet） 的 8x8 精灵视图。但也可以使用自由形态工具（抓手，选择）来处理更大或大小古怪的区域。

### 绘图工具

在精灵上点击并拖动以绘制像素，或者使用右键来选择指针底下的颜色。

所有操作只应用于可见区域，或是存在的选区。

按住 CTRL 来搜索并替换颜色

### 图章工具

点击可以把复制缓冲区里的图像盖上去。按住 CTRL 把颜色 0（黑色）视作透明。

### 选择工具（快捷键：SHIFT 或 S）

点击并拖动来创建矩形选区。要删除选区，按 ENTER 或点击别处。

如果不存在像素级选区，大部分操作就应用到精灵级选区，或者可见视图。要选择精灵，在精灵浏览器中按住 Shift 并拖动。要选择精灵表，按下 CTRL-A（重复多次可以切换是否选择与地图数据共享的下半部分）

### 抓手工具（快捷键：SPACE）

点击并拖动以在精灵表上四处移动。

### 填充工具

用当前颜色填充。这仅应用于当前选区，没有选区时则是可见区域。

### 形状工具

点击工具按钮以循环切换：椭圆，矩形，直线选项。

按住 CTRL 可以得到填充椭圆或矩形。  
按住 SHIFT 可以固定为圆形，正方形，或者低整数比的直线。

### 额外快捷键

CTRL-Z：撤销  
CTRL-C/X：复制 / 剪切选择的区域或者选择的精灵  
CTRL-V：粘贴到当前精灵位置  
Q/A，W/Z：切换到上一个 / 下一个精灵  
1，2：切换到上一种 / 下一种颜色  
TAB：切换全屏视图  
鼠标滚轮或者 < 和 > 来放大缩小（全屏下居中）  
CTRL-H：切换十六进制视图（以十六进制显示精灵索引）  
CTRL-G：切换放大时显示的黑色网格线

### 对选择区域或选择精灵的操作

F：水平翻转精灵  
V：垂直翻转精灵  
R：旋转（需要一个正方形选区）  
方向键移动（如果是选择精灵，则会循环移动）  
DEL/BACKSPACE：清除选区内图像

### 精灵标志

8 个有色圆圈是当前精灵的精灵标志。虽然标志没有特定含义，但是可以用 `FGET()` / `FSET()` 函数来访问。它们从索引 0 开始，从左到右检索。

查阅 `FSET()` 获取更多信息。

### 加载 .png 文件到精灵表

要把任意大小的 png 文件加载到精灵表，首先选择作为加载目的地左上角的精灵，然后输入 `IMPORT IMAGE_FILE.PNG` 或者拖放图像文件到 PICO-8 窗口。无论哪种方式，图像的颜色都会贴近到当前的显示色板。

## 2.3 地图编辑器

PICO-8 地图是一块由 8 位数值组成的 128x32（如果用到了共享空间，那就是 128x64 ）。编辑器内显示的每个数值都是对精灵的引用（0..255），但是你当然也可以用这些数据表示你想要的任何东西。

> [!WARNING]
>
> 精灵表的另一半（Bank 2 和 3），和地图的下半部分共享相同的卡带空间。如何使用这些数据取决于你，但请注意在精灵表的另一半绘图会破坏地图的数据，反之也是。

工具与精灵编辑模式下的比较相似。选择一个精灵，点击并拖动以在地图上填入数值。

要绘制多个精灵，用 Shift+拖动 从精灵浏览器中选择。要复制一块数值，用选择工具复制，随后用图章工具来粘贴。要四处浏览地图，使用抓手工具或者按住 Space。用 Q，W 来切换上一个/下一个精灵。用鼠标滚轮或者 < 和 > 来放大缩小（全屏下居中）。用 CTRL-H 切换十六进制视图（用十六进制显示瓦片（tile）数值和精灵索引）

在精灵表中移动精灵而不会破坏地图中对精灵的引用会有点棘手，但是是可行的：

1. 按 ENTER 删除地图选区

2. 选择你想要移动的精灵（保持在地图视图），按下 CTRL-X

3. 选择要影响的地图区域（默认是地图的上半部分）

   // 按下 CTRL-A 两次选择完整的地图，包括共享内存部分

4. 选择目标精灵（依然保持在地图视图），按下 CTRL-V

> [!NOTE]
>
> 这项操作虽然会同时修改地图和精灵编辑器的撤销历史，但是 PICO-8 会尽量使它们保持同步。否则，移动地图精灵导致的改动可以通过在精灵编辑器中手动撤销来取消。

## 2.4 SFX 编辑器

卡带内有 64 个 SFX（“声音效果”），既用于音效也用于音乐。

每个 SFX 有 32 个音符，每个音符有：

频率（C0..C5）  
乐器（0..7）  
音量（0..7）  
效果（0..7）

每个 SFX 还有这些属性：

回放速度（SPD）：每个音符演奏使用的“时间刻”数量。  
// 这意味着 1 是最快的，3 是 3 倍的慢，以此类推

循环（LOOP）头和尾：这是循环折回和循环结尾的音符索引  
// 当起始索引索引大于等于结束索引时，循环被关闭

只用到第一个的两位数（第二个是 0）的时候，意思就是演奏的音符数量。对音效来说，正常是不需要的（你可以把剩余的音符留空），其适用于控制音乐回放。

编辑 / 查看 SFX 有两种模式：音高模式（更适合音效）和 Tracker 模式（更适合音乐）。模式可以用左上角的按钮切换，或者用 TAB 切换。

### 音高模式

在音高区域点击并拖动来设置每个音符的频率，音符使用的是当前选择的乐器（由颜色指示）。

按住 Shift 只应用于选择的乐器的音符。  
按住 CTRL 使输入的音符吸附到 C 小调五声音阶。  
右键获取指定音符的乐器

### Tracker 模式

每个音符显示：频率 八度 乐器 音量 效果  
要输入一个音符，使用 q2w3er5t6y7ui zsxdcvgbhnjm（类似钢琴的布局）  
输入音符时，按住 Shift 进行移调，-1 八度 .. +1 八度  
新音符会使用选择的乐器 / 效果数值  
要删除一个音符，使用 Backspace 或设置音量为 0

点击然后 Shift-点击 来选择一个范围，可以复制（CTRL-C）和粘贴（CTRL-V）。注意只有选中的属性会被复制。双击选择单个音符的所有属性。

浏览：

PAGEUP/DOWN 或 CTRL-UP/DOWN 向上或向下跳过 4 个音符  
HOME/END 跳转到第一个或最后一个音符  
CTRL-LEFT/RIGHT 在不同的列之间跳转

### 两种模式的控制

\- \+ 切换当前 SFX  
< > 切换速度。SPACE 播放 / 停止  
SHIFT-SPACE 从当前的 SFX quarter 开头开始播放（8 个音符一组）  
A 释放循环采样  
左键或右键来增加 / 减少 SPD 或 LOOP 数值  
// 点击时按住 Shift 来增加 / 减少 4  
// 还有一种方法，点击并向左/向右或向上/向下拖动  
Shift-点击 一个乐器，效果或音量以将其应用到所有音符。

### 效果

| 数值 | 效果                      | 注释                          |
| ---- | ------------------------- | ----------------------------- |
| 0    | 无（none）                |                               |
| 1    | 滑音（slide）             | 音高和音量滑向下一个音符      |
| 2    | 颤音（vibrato）           | 在一个四分音符内快速变化音高  |
| 3    | 降调（drop）              | 频率快速下降到很低的数值      |
| 4    | 淡入（fade in）           | 音量从 0 往上逐渐变高         |
| 5    | 淡出（fade out）          | 音量往下逐渐变为 0            |
| 6    | 快速琶音（arpeggio fast） | 迭代 4 个音符的一组，速度为 4 |
| 7    | 慢速琶音（arpeggio slow） | 迭代 4 个音符的一组，速度为 8 |

如果 SFX 速度小于等于 8，琶音速度减半到 2，4

### 滤镜

每个 SFX 有 5 个滤镜开关，可以在 Tracker 模式下访问：

| 滤镜     | 描述                                                 |
| -------- | ---------------------------------------------------- |
| NOIZ     | 生成纯白噪音（仅适用于乐器 6）                       |
| BUZZ     | 对波形进行多种修改，使其听起来更加嗡嗡叫             |
| DETUNE-1 | 对第二个音做失谐处理，创造一种类似镶边的效果         |
| DETUNE-2 | 对第二个音做各种调音处理，大部分是调高或调低一个八度 |
| REVERB   | 应用一个带有 2 或 4 个时间刻的延音的回声效果         |
| DAMPEN   | 两种不同等级下的低通滤波器                           |

当 BUZZ 和乐器 6 一起使用，NOIZ 处于关闭状态时，程序会生成纯褐噪音。

## 2.5 音乐编辑器

PICO-8 中的音乐是由一系列样式（Pattern）控制。每个样式是一个 4 个数值的列表，其指出哪个 SFX 会在那个通道上播放。

### 流控制

回放流可以使用右上角的 3 个按钮来控制。

当一个样式播放结束后，下一个样式就会播放，除非：

- 没有可以播放的数据（音乐停止）
- 在这个样式上设置了 `STOP` 命令（第三个按钮）
- 设置了一个 `LOOP BACK` 命令（第二个按钮），在这种情况下，音乐播放器会往回寻找设置了 `LOOP START` 命令（第一个按钮）的样式并播放，如果找不到就回到样式 0。

当一个样式有不同速度的 SFX，样式仅当最左边的非循环通道播放结束后才结束播放。这可以用来建立双节拍鼓点或不寻常的复合节奏。

对于类似 3/4 的拍号，跳转到下一个样式前应播放小于 32 行的音符，SFX 的长度可以通过只设置第一个循环点，第二个循环点保持为 0 来设置。这会在 SFX 编辑器中显示 `LEN`（表示“长度”）而不是 `LOOP`。

### 复制和粘贴音乐

要选择一系列样式：在样式浏览器中点击一次第一个样式，然后 Shift-点击 最后一个样式。选择的样式可以用 CTRL-C 和 CTRL-V 来复制粘贴。粘贴到其他卡带时，如果 SFX 不存在，样式指向的 SFX 也会被粘贴（索引可能不同）。

### SFX 乐器

除了 8 个内置乐器，可以使用开头的 8 个 SFX 来定义自定义乐器。使用乐器右边的切换按钮来选择一个索引，这个索引会在乐器通道中显示绿色而不是粉色。

演奏一个 SFX 乐器音符的时候，本质上就是触发那个 SFX，但是会修改音符的属性：

音高相对于 C2 相加  
音量相乘  
效果会应用在 SFX 乐器效果之上  
任何 SFX 乐器上的滤镜都会对这个音符启用

例如，我们可以实现一个简单的震音效果，方法是在 SFX 0 定义一个乐器，其会在音量 5 和 2 之间快速交替。当使用这个乐器演奏一个音符时，音量可以和往常一样进一步修改（使用音量通道或使用淡入淡出效果）。通过这种方式可以使用 SFX 乐器控制音量，音高和音色的精细变化。

SFX 乐器只在音高改变，或者前一个音符的音量为 0 的时候重新触发。这适用于随时间推移缓慢变化的乐器。例如：逐渐淡出的钟声。要避免这种行为，触发音符时可以使用效果 3（正常是“降调”）。所有其他的效果数值在触发 SFX 乐器时含义与往常相同。

### 波形乐器

波形乐器和 SFX 乐器的运作方式相同，但是其包含了一个自定义的 64 字节循环波形。点击 SFX 编辑器里的波形开关按钮以使用 SFX 0..7 作为波形乐器。在这种模式下，采样可以用鼠标绘制。

### 音阶吸附

在音高模式下绘制音符时，按住 CTRL 可以吸附到当前定义的音阶。默认是 C 小调五声音阶，可以使用音阶编辑器模式自定义。右下角有个小小的键盘图标可以切换这个模式。有 2 个转调按钮，1 个反转按钮和 3 个音阶预设按钮：

> Dim  6 减 6 音阶 - 反转得到全半音阶  
> Maj  大调音阶 - 反转得到五声音阶  
> Who  全音阶 - 反转得到 ... 其他的全音阶

改变音阶并不会影响当前的 SFX，仅当按住 CTRL 绘制新音符的时候影响，此时会应用新的音阶。

# 3 导入工具 / 导出工具

`EXPORT` 命令用于生成 png，wav 文件，独立的 html 和原生二进制卡带应用程序。输出格式从文件扩展名推断（例如 .png）。

你可以随意分发和使用导出的卡带和数据，只要你获得卡带作者和贡献者的许可。

- **精灵列表 / 标签（.png）**

``````
> IMPORT BLAH.PNG   -- EXPECTS 128X128 PNG AND COLOUR-FITS TO THE PICO-8 PALETTE
> EXPORT BLAH.PNG   -- USE THE "FOLDER" COMMAND TO LOCATE THE EXPORTED PNG
``````

导入的时候，`-x` 和 `-y` 开关可以用来以像素为单位指定目标位置；`-s` 可以用来缩小图像（3 的意思是从 384x384 缩小到 128x128）

``````
> IMPORT BLAH.PNG -X 16 -Y 16 -S 3
``````

和 `IMPORT` 和 `EXPORT` 一起使用`-l` 开关则可以读写卡带的标签：

``````
> IMPORT -L BLAH.PNG
``````

> [!NOTE]
>
> 导入精灵表或标签时，色板的颜色会贴合到当前绘制状态的色板。

- **SFX 和音乐（.wav）**

从当前样式导出音乐（当编辑器模式是音乐），或者当前 SFX：

``````
> EXPORT FOO.WAV  
``````

导出所有的 SFX 为 foo0.wav，foo1.wav .. foo63.wav：

``````
> EXPORT FOO%D.WAV
``````

- **地图和代码**

卡带的地图或源代码可以导出为单一图片，叫做 `.map.png` 或 `.lua.png`：

``````
> EXPORT FOO.MAP.PNG
> EXPORT FOO.LUA.PNG
``````

地图图像是 1024X512（128x32 的 8x8 精灵）。Lua 图片的大小会设置为合适大小，但是每一行固定（同时被裁剪）为 192 像素宽。

- **卡带（.p8，.p8.png，.p8.rom）**

使用 `EXPORT` 保存卡带和使用 `SAVE` 差不多，但并不会改变当前编辑的卡带。例如，这可以用于以 `.p8.png` 格式保存一份副本用于分发，不会意外地在这份副本，而不是原始的 `.p8` 文件上做改动。

`EXPORT` 还可以用于从命令行进行卡带文件格式转换。例如，在 Linux shell 上：

``````shell
> pico8 foo.p8 -export foo.p8.png
``````

## 3.1 Web 应用程序（.html）

生成一个独立的 html 播放器（mygame.html，mygame.js）：

``````
> EXPORT MYGAME.HTML
``````

或者只要 `.js` 文件：

``````
> EXPORT MYGAME.JS
``````

使用 `-f` 把文件写到一个叫 `mygame_html` 的文件夹，使用 `index.html` 而不是 `mygame.html`

``````
> EXPORT -F MYGAME.HTML
``````

可选的，可以用 `-p` 开关提供一个自定义的 html 模版：

``````
> EXPORT MYGAME.HTML -P ONE_BUTTON
``````

这会使用文件 `{application data}/pico-8/plates/one_button.html` 作为 html 外壳，替换一个特殊字符串 `##js_file##` 为 `.js` 文件名。可选的，替换字符串 `##label_file##` 为卡带标签图片的 Data URL。

使用 `-w` 导出为 `.wasm` \+ `.js` ：

``````
> EXPORT -W MYGAME.HTML
``````

> [!NOTE]
>
> 导出为 `.wasm` 的时候，页面必须由一个 Web 服务器提供，而不是直接从本地文件系统中用浏览器打开。对大部分用途而言，默认的 `.js` 导出没啥问题，但是 `.wasm` 稍微小一点也快一点。

## 3.2 二进制应用程序（.bin）

给 Windows，Linux（64 位），Mac 和树莓派生成独立可执行程序：

``````
> EXPORT MYGAME.BIN
``````

默认情况下，卡带标签用作图标，不透明。要从精灵表中指定一个图标，使用 `-i` ，可选的使用 `-s` 并 / 或使用 `-c` 控制大小和透明。

> -I N  图标索引为 N，默认透明色是 0（黑色）。  
> -S N  大小为 NxN 的精灵。大小 3 会产生 24x24 大小的图标。  
> -C N  把颜色 N 当作透明色。使用 16 表示不透明。

例如，使用精灵表中索引 32 开始的 2x2 精灵，使用颜色 12 作为透明色：

``````
> EXPORT -I 32 -S 2 -C 12 MYGAME.BIN
``````

要在输出文件夹和压缩档案中包含额外的文件，使用 `-E` 开关：

``````
> EXPORT -E README.TXT MYGAME.BIN
``````

> [!NOTE]
>
> Windows 文件系统不支持创建 Linux 或 Mac 可执行文件所需的文件元数据。PICO-8 通过导出保留文件属性的 zip 文件来解决这个问题。因此，建议把输出的 zip 文件原样分发，以保证其他操作系统的用户能运行。否则，下载了二进制文件的 Linux 用户可能需要对文件使用 `chmod +x mygame` 才能运行，Mac 用户需要使用 `chmod +x mygame.app/Contents/MacOS/mygame`

## 3.3 上传到 itch.io

如果你想要把你导出的卡带上传到 itch.io，生成可游玩的 html：

1. 在 PICO-8 内：`EXPORT -F MYGAME.HTML`

2. 在你的 itch 创作中心创建一个新项目

3. 把文件夹打包为 zip 并上传（设置 “这个文件会在浏览器中游玩”）

4. 设置嵌入到页面，大小为 750px x 680px

5. 勾选“移动设备支持”（默认方向）以及“页面加载时自动启动”

   // 不需要全屏按钮，因为默认的 PICO-8 模版已经有自己的全屏按钮了

6. 设置背景颜色（BG2）为暗一点的颜色（例如 `#232323`），文本为亮一点的颜色（`#cccccc`）

## 3.4 导出多个卡带

生成独立的 html 或原生二进制播放器时，多达 16 个卡带可以传递给 `EXPORT` 以打包在一起。

``````
> EXPORT MYGAME.HTML DAT1.P8 DAT2.P8 GAME2.P8
``````

运行时，附加的卡带可以像本地文件一样访问：

``````lua
RELOAD(0,0,0X2000, "DAT1.P8") -- 从 DAT1.P8 读取精灵表
LOAD("GAME2.P8")              -- 加载并运行另一个卡带
``````

> [!NOTE]
>
> 导出的卡带不能加载并运行 BBS 卡带，例如使用 `LOAD("#FOO")`

## 3.5 从宿主操作系统运行 EXPORT

运行 PICO-8 时，使用 `-export` 开关可以以无头模式启动导出工具。文件路径相对于当前目录，而不是 PICO-8 的文件系统。

`EXPORT` 命令的参数以一个单一（小写）字符串传入：

``````shell
pico8 mygame.p8 -export "-i 32 -s 2 -c 12 mygame.bin dat0.p8 dat1.p8"
``````

# 4 Lua 语法入门

PICO-8 程序使用 Lua 语法编写，但是不使用 Lua 标准库。以下是对 Lua 精华语法的简单总结。

要获取更多细节，或者查询正规 Lua 语法，参阅 www.lua.org。

## 注释

``````lua
-- 使用像这样的两个横杠写一条注释
--[[ 多行
注释 ]]
``````

## 数据类型和赋值

Lua 里的数据类型有数字（number），字符串（string），布尔值（boolean）和表（table）：

``````lua
NUM = 12/100
S = "这是一个字符串"
B = FALSE
T = {1,2,3}
``````

PICO-8 里的数字都是 16:16 的定点数。数值范围从 -32768.0 到 32767.99999

可以使用十六进制记号，带有可选的分数部分：

``````lua
?0x11        -- 17
?0x11.4000   -- 17.25
``````

用十进制书写的数字会四舍五入至最近的定点数值。要查看 32 位十六进制的表示结果，使用 `PRINT(TOSTR(VAL,TRUE))` ：

``````lua
?TOSTR(-32768,TRUE)      -- 0x8000.0000
?TOSTR(32767.99999,TRUE) -- 0X7FFF.FFFF
``````

如果是正数，除以 0 的结果是 0x7fff.ffff；如果是负数，除以 0 的结果是 -0x7ffff.ffff。

## 条件分支

``````lua
IF NOT B THEN
  PRINT("B 是 FALSE")
ELSE
  PRINT("B 不是 FALSE")
END
``````

带 `ELSEIF`

``````lua
IF X == 0 THEN
  PRINT("X 是 0")
ELSEIF X < 0 THEN
  PRINT("X 是负数")
ELSE
  PRINT("X 是正数")
END
``````

``````lua
IF (4 == 4) THEN PRINT("相等") END
IF (4 ~= 3) THEN PRINT("不相等") END
IF (4 <= 4) THEN PRINT("小于或等于") END
IF (4 > 3) THEN PRINT("大于") END
``````

## 循环

循环区间是闭区间：

``````lua
FOR X=1,5 DO
  PRINT(X)
END
-- 打印 1,2,3,4,5
``````

``````lua
X = 1
WHILE(X <= 5) DO
  PRINT(X)
  X = X + 1
END
``````

``````lua
FOR X=1,10,3 DO PRINT(X) END   -- 1,4,7,10
``````

``````lua
FOR X=5,1,-2 DO PRINT(X) END  -- 5,3,1
``````

## 函数和局部变量

声明为 `LOCAL` 的变量，作用域是包含它们的代码块（例如，在 `FUNCTION` 里面，一个 `FOR` 循环，或者 `IF THEN END` 表达式）。

``````lua
Y=0
FUNCTION PLUSONE(X)
  LOCAL Y = X+1
  RETURN Y
END
PRINT(PLUSONE(2)) -- 3
PRINT(Y)          -- 0
``````

## 表

在 Lua 中，表是键值对的集合，键和值的类型都可以混合。用整数检索，表可以用作数组。

``````lua
A={} -- 创建一个空表
A[1] = "BLAH"
A[2] = 42
A["FOO"] = {1,2,3}
``````

数组默认使用以 1 开始的索引：

``````lua
> A = {11,12,13,14}
> PRINT(A[2]) -- 12
``````

但如果你更喜欢以 0 开始的数组，只要在 0 号槽位写入东西：

``````lua
> A = {[0]=10,11,12,13,14}
``````

但是使用以 1 开始的索引的表更特殊。这种数组的长度可以用 `#` 运算符得到，PICO-8 用这样的数组实现了 `ADD` ，`DEL` ，`DELI` ，`ALL` 和 `FOREACH` 函数。

``````lua
> PRINT(#A)   -- 4
> ADD(A, 15)
> PRINT(#A)   -- 5
``````

字符串索引可以用点记号书写

``````lua
PLAYER = {}
PLAYER.X = 2 -- 等价于 PLAYER["X"]
PLAYER.Y = 3
``````

若要获取更多细节，参阅“表函数”小节。

## PICO-8 简写语法

PICO-8 还允许用一些非标准，简短的方法来书写常见模式。

1. `IF THEN END` 表达式，和 `WHILE THEN END` 可以像这样写在一行上：

   ``````lua
   IF (NOT B) I=1 J=2
   ``````

   这等价于：

   ``````lua
   IF NOT B THEN I=1 J=2 END
   ``````

   注意简写条件周围的括号是必需的。

2. 赋值运算符

   如果整个表达式在一行上，可以使用简写的赋值运算符。往任意二元运算符后面添加一个 `=` 就能构建，包括算术运算（`+=`，`-=` ..），位运算（`&=`，`|=` ..）或字符串拼接运算符（`..=`）

   ``````lua
   A += 2   -- 等价于: A = A + 2
   ``````

   // 注意左值出现了两次，所以对于 `TBL[FN()]+=1` ，`FN()` 会被调用两次。

3. `!=` 运算符

   并非简写，但是 PICO-8 也接受用 `!=` 取代 `~=` 来表示“不相等”

   ``````lua
   PRINT(1 != 2) -- TRUE
   PRINT("FOO" == "FOO") -- TRUE (字符串驻留)
   ``````

# 5 PICO-8 程序结构

一个 PICO-8程序运行的时候，选项卡里的所有代码都会被拼接起来（从左到右）并执行。虽然手动提供你自己的主循环是可行的，但是典型的 PICO-8 程序会使用 3 个特殊的函数，如果作者有定义这些函数，函数就会在程序执行期间被调用：

`_UPDATE()` -- 以 30fps 的频率，每次更新时调用  
`_DRAW()` -- 绘制每个可见帧时会调用一次  
`_INIT()` -- 程序启动时调用一次

使用以上三个函数的简单程序看上去大概是这样的：

``````lua
FUNCTION _INIT()
  -- 永远以白色开始
  COL = 7
END
 
FUNCTION _UPDATE()
  -- 按 X 得到一个随机色
  IF (BTNP(5)) COL = 8 + RND(8)
END
 
FUNCTION _DRAW()
  CLS(1)
  CIRCFILL(64,64,32,COL)
END
``````

`_DRAW()` 正常以 30fps 的频率调用，但是如果该函数无法及时执行完成，PICO-8 将会尝试以 15fps 的帧率运行，每个可见帧会调用两次 `_UPDATE()` 来补偿。

## 以 60fps 的帧率运行 PICO-8

`_UPDATE60()`

当定义了 `_UPDATE60()` 而不是 `_UPDATE()` 的时候，PICO-8 会运行在 60fps 模式：

\- `_UPDATE60()` 和 `_DRAW()` 都会以 60fps 的频率调用  
\- 降至 30fps 之前，每帧的 PICO-8 CPU 是一半空闲的

注意不是所有的宿主机器都支持运行在 60fps 。老机器以及 / 或 Web 版本可能会请求 PICO-8 运行在 30fps（或 15fps），即使 PICO-8 CPU 并没有超出负荷。在这种情况下，用同样的方法，每次 `_DRAW` 调用时都会调用多次 `_UPDATE60` 。

## #INCLUDE

源代码可以在卡带启动时（但不是在运行时）注入程序，使用 `#INCLUDE FILENAME` ，其中 `FILENAME` 要么是纯文本文件（包含 Lua 代码），要么是另一个卡带的一个选项卡，要么是另一个卡带的所有选项卡：

``````lua
#INCLUDE SOMECODE.LUA
#INCLUDE ONETAB.P8:1
#INCLUDE ALLTABS.P8
``````

卡带运行的时候，每个被包含文件的内容就好像被粘贴到编辑器中，`#INCLUDE`那一行的位置一样。

\- 文件名相对于当前的卡带（所以要先保存）  
\- 包含并不是递归执行的  
\- 正常字符计数和 Token 限制同样适用

当卡带保存为 `.P8.PNG` ，或者导出为二进制，任何包含的文件会被扁平化，和卡带一同保存，这样就不存在外部依赖了。

`#INCLUDE` 可以用在像是：

\- 卡带之间共享代码（库或者多卡带共用代码）  
\- 使用外部代码编辑器，且不需要直接编辑 `.p8` 文件  
\- 把卡带当作数据文件，其会加载到 PICO-8 编辑工具以进行修改  
\- 加载并存储由外部（并非 PICO-8）工具生成的数据

## PICO-8 中需要留意的地方

常见的要注意的地方有：

\- 精灵表的下半部分和地图的下半部分占据同一块内存。// 如果你不清楚这是怎么一回事，最好只使用其中一部分  
\- PICO-8 数字的精度和范围有限；数字之间的最小差距大约是 0.00002（0x0.0001），范围从 -32768 到大约 32767.99999（0x7ffff.ffff）// 如果你每一帧给一个计数器加 1，大约 18 分钟后它就会溢出！  
\- Lua 数组默认从 1 开始，而不是从 0 开始，`FOREACH` 从 `TBL[1]` 开始，而不是从 `TBL[0]` 开始。  
\- `COS()` 和 `SIN()` 接受 0..1 而不是 0..PI*2 ，并且 `SIN()` 执行结果的符号是反的（即正数结果实际返回负数，反之也是）。

## CPU

虽然 PICO-8 并没有一个清晰定义的 CPU，但是存在一个速度为 8MHz 的虚拟 CPU，其中每个 Lua 虚拟机指令消耗大约 2 个周期。内置操作像是绘制精灵也会有 CPU 开销。这意味着在一台有高性能 CPU 的宿主机上制作的 PICO-8 卡带依然能保证在更为缓慢的机器上运行（大致）良好，在手机 / 在 Web 上运行时不会消耗太多电池。

在卡带运行的时候要查看 CPU 负载，请按 CTRL-P 切换出 CPU 量表，或者在每帧的结尾打印 `STAT(1)` 的结果。
